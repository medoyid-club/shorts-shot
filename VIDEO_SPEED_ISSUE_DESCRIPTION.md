# Проблема с ускорением видео и синхронизацией CSS анимаций

## Контекст проекта

Проект генерирует YouTube Shorts (1080x1920, 6 секунд) используя HTML+Selenium подход:
- HTML шаблон рендерится в браузере через Selenium
- Кадры захватываются через Chrome DevTools Protocol (CDP)
- Видео создается из кадров через OpenCV + FFmpeg

## Текущая реализация

### 1. Обработка видео (Python, `services/video_generator_v2.py`)

```python
def _preprocess_media(self, media_path: str) -> Optional[str]:
    """Обрезает видео до 6 секунд"""
    if ext in ['.mp4', '.webm', '.mov']:
        command = [
            'ffmpeg', '-y',
            '-ss', '0',  # Начинаем с начала
            '-i', str(media_path),
            '-t', str(self.duration),  # Длительность 6 секунд
            '-c', 'copy',  # Копируем без перекодирования
            '-avoid_negative_ts', 'make_zero',
            '-loglevel', 'error',
            str(trimmed_path)
        ]
        # ... обработка результата
```

### 2. HTML шаблон (`resources/templates/news_short_v3.html`)

```html
<video id="mediaVideo" autoplay loop muted playsinline>
    <source src="{{NEWS_VIDEO}}" type="video/mp4">
</video>
```

```css
.media-zone video,
.media-zone img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    /* Эффект экшен-камеры - синхронизировано с 6 секундами */
    animation: cinematicMove 6s ease-in-out infinite;
}

@keyframes cinematicMove {
    0% {
        transform: scale(1) translate(0, 0);
    }
    50% {
        transform: scale(1.05) translate(-8px, -8px);
    }
    100% {
        transform: scale(1) translate(0, 0);
    }
}
```

```javascript
mediaVideo.addEventListener('loadeddata', function() {
    mediaVideo.playbackRate = 1.0;  // Нормальная скорость
    mediaVideo.loop = true;
});
```

### 3. Захват кадров (Python)

```python
def _capture_animation_frames_cdp(self) -> list:
    """Захватывает 180 кадров (6 секунд × 30 FPS)"""
    num_frames = int(self.duration * self.fps)  # 180 кадров
    for i in range(num_frames):
        screenshot_data = self.driver.execute_cdp_cmd("Page.captureScreenshot", {...})
        # ... обработка кадра
```

## Проблема

**Симптомы:**
1. Видео проигрывается ускоренно (быстрее чем должно)
2. CSS анимация `cinematicMove` также ускорена и синхронизирована с ускоренным видео
3. В результате: видео завершается раньше 6 секунд, анимация тоже завершается раньше

**Ожидаемое поведение:**
- Видео должно быть обрезано до 6 секунд и проигрываться с нормальной скоростью (1x)
- CSS анимация должна длиться ровно 6 секунд и синхронизироваться с реальным временем воспроизведения видео
- При захвате кадров: каждый кадр должен соответствовать правильному моменту времени (кадр 0 = 0 сек, кадр 90 = 3 сек, кадр 180 = 6 сек)

## Возможные причины

1. **FFmpeg обрезка:** `-c copy` может работать некорректно, обрезая по ключевым кадрам, что может изменить длительность
2. **Браузерное воспроизведение:** Браузер может ускорять видео для синхронизации с чем-то
3. **Синхронизация захвата:** Кадры захватываются слишком быстро, не дожидаясь реального времени воспроизведения
4. **CSS анимация:** Анимация привязана к времени браузера, а не к реальному времени видео

## Требования к решению

1. Видео должно быть точно 6 секунд и проигрываться с нормальной скоростью
2. CSS анимация должна быть синхронизирована с реальным временем видео (не с ускоренным)
3. При захвате кадров нужно учитывать реальное время воспроизведения видео
4. Loop должен работать плавно без прыжков

## Дополнительная информация

- Длительность шортса: 6 секунд (`self.duration = 6`)
- FPS: 30 (`self.fps = 30`)
- Размер: 1080x1920
- Метод захвата: Chrome DevTools Protocol (CDP)
- Браузер: Chrome в headless режиме

## Вопросы для решения

1. Как правильно обрезать видео до 6 секунд без изменения скорости?
2. Как синхронизировать CSS анимацию с реальным временем воспроизведения видео (а не с ускоренным)?
3. Нужно ли добавлять задержки между захватом кадров для синхронизации с реальным временем?
4. Может ли проблема быть в том, что браузер ускоряет видео для синхронизации с чем-то другим?

